<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Регистрация мастера</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary: #ff6b9d;
      --bg: #f9f9f9;
      --card: #ffffff;
      --text: #333333;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body {
      background: var(--bg);
      color: var(--text);
      padding: 16px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { text-align: center; margin: 16px 0 24px; font-weight: 600; font-size: 20px; }

    input, textarea, button, select {
      width: 100%; padding: 14px; margin: 12px 0;
      border: 1px solid #ddd; border-radius: 12px; font-size: 16px;
    }
    button {
      background: var(--primary); color: white; border: none; cursor: pointer;
    }
    button:disabled { background: #ccc; }

    .service-item, .schedule-item {
      background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .remove-btn {
      background: #ff6b6b; color: white; border: none; padding: 6px 12px;
      border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 8px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Регистрация мастера</h1>
    
    <input type="text" id="name" placeholder="Имя мастера" required />
    <input type="url" id="photoUrl" placeholder="Ссылка на фото (опционально)" />

    <h3>Услуги</h3>
    <div id="servicesList"></div>
    <button type="button" onclick="addService()">+ Добавить услугу</button>

    <h3>Расписание</h3>
    <div id="scheduleList"></div>
    <button type="button" onclick="addScheduleDay()">+ Добавить день</button>

    <button id="submitBtn" onclick="submitMaster()">Сохранить</button>
  </div>

  <script>
    // === Инициализация ===
    let services = ["Маникюр"];
    let schedule = [];

    function addService() {
      services.push("Новая услуга");
      renderServices();
    }

    function removeService(index) {
      services.splice(index, 1);
      renderServices();
    }

    function renderServices() {
      const el = document.getElementById("servicesList");
      el.innerHTML = services.map((s, i) => `
        <div class="service-item">
          <input type="text" value="${s}" oninput="services[${i}] = this.value" placeholder="Услуга" required />
          <button type="button" class="remove-btn" onclick="removeService(${i})">Удалить</button>
        </div>
      `).join('');
    }

    function addScheduleDay() {
      const today = new Date().toISOString().split('T')[0];
      schedule.push({ date: today, times: ["10:00", "14:00"] });
      renderSchedule();
    }

    function removeScheduleDay(index) {
      schedule.splice(index, 1);
      renderSchedule();
    }

    function addTimeToDay(dayIndex) {
      schedule[dayIndex].times.push("10:00");
      renderSchedule();
    }

    function removeTimeFromDay(dayIndex, timeIndex) {
      schedule[dayIndex].times.splice(timeIndex, 1);
      renderSchedule();
    }

    function renderSchedule() {
      const el = document.getElementById("scheduleList");
      el.innerHTML = schedule.map((day, i) => `
        <div class="schedule-item">
          <input type="date" value="${day.date}" oninput="schedule[${i}].date = this.value" required />
          <div>
            ${day.times.map((t, ti) => `
              <div style="display:flex; gap:8px; margin:6px 0;">
                <input type="time" value="${t}" oninput="schedule[${i}].times[${ti}] = this.value" required />
                <button type="button" class="remove-btn" style="padding:4px 8px;" onclick="removeTimeFromDay(${i}, ${ti})">–</button>
              </div>
            `).join('')}
            <button type="button" class="remove-btn" style="margin-top:8px;" onclick="addTimeToDay(${i})">+ Время</button>
          </div>
          <button type="button" class="remove-btn" style="margin-top:12px;" onclick="removeScheduleDay(${i})">Удалить день</button>
        </div>
      `).join('');
    }

    // === Отправка данных ===
    function submitMaster() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("Введите имя мастера");
        return;
      }

      if (services.length === 0) {
        alert("Добавьте хотя бы одну услугу");
        return;
      }

      if (schedule.length === 0) {
        alert("Добавьте хотя бы один день в расписании");
        return;
      }

      // Проверяем, что все времена заполнены
      for (const day of schedule) {
        if (!day.date) {
          alert("Выберите дату");
          return;
        }
        for (const t of day.times) {
          if (!t) {
            alert("Заполните все временные слоты");
            return;
          }
        }
      }

      const photoUrl = document.getElementById("photoUrl").value.trim() ||
                       "https://i.imgur.com/8KmWnJQ.jpg";

      Telegram.WebApp.sendData(JSON.stringify({
        is_master_registration: true,
        name: name,
        photo_url: photoUrl,
        services: services,
        schedule: schedule
      }));

      Telegram.WebApp.close();
    }

    // === Старт ===
    renderServices();
    addScheduleDay(); // добавляем один день по умолчанию
  </script>
</body>
</html>